import * as fs from 'fs';import * as path from 'path';import * as os from 'os';/** * Skill 信息 */export interface SkillInfo {    name: string;    path: string;           // 文件完整路径    description: string;    isEnabled: boolean;     // 是否已激活    source: 'local' | 'github';    sourceUrl?: string;}/** * 获取 Skills 目录路径 (Claude 官方路径) * 已激活的 skills 直接放在这个目录下 */export function getSkillsPath(): string {    return path.join(os.homedir(), '.claude', 'skills');}/** * 获取禁用 Skills 目录路径 */export function getDisabledPath(): string {    return path.join(getSkillsPath(), '.disabled');}/** * 确保目录存在 */export async function ensureDirectoriesExist(): Promise<void> {    const skillsPath = getSkillsPath();    const disabledPath = getDisabledPath();    if (!fs.existsSync(skillsPath)) {        await fs.promises.mkdir(skillsPath, { recursive: true });    }    if (!fs.existsSync(disabledPath)) {        await fs.promises.mkdir(disabledPath, { recursive: true });    }}/** * 从 SKILL.md 提取描述 */async function extractDescriptionFromFile(filePath: string): Promise<string> {    try {        const content = await fs.promises.readFile(filePath, 'utf-8');        // 从 YAML frontmatter 提取 description        const yamlMatch = content.match(/^---\s*\n([\s\S]*?)\n---/);        if (yamlMatch) {            const descMatch = yamlMatch[1].match(/description:\s*(.+)/);            if (descMatch) {                return descMatch[1].trim().replace(/^["']|["']$/g, '');            }        }        // 取第一个非标题、非frontmatter行        const firstLine = content.split('\n').find(line =>            line.trim() && !line.startsWith('#') && !line.startsWith('---')        );        return firstLine?.trim().substring(0, 200) || '';    } catch {        return '';    }}/** * 从目录提取描述 */async function extractDescriptionFromDir(dirPath: string): Promise<string> {    const skillMd = path.join(dirPath, 'SKILL.md');    if (fs.existsSync(skillMd)) {        return extractDescriptionFromFile(skillMd);    }    return '';}/** * 扫描目录中的 skills * 官方标准：只识别包含 SKILL.md 的目录 */async function scanDirectory(dirPath: string, isEnabled: boolean): Promise<SkillInfo[]> {    const skills: SkillInfo[] = [];    if (!fs.existsSync(dirPath)) {return skills;}    try {        const entries = await fs.promises.readdir(dirPath, { withFileTypes: true });        for (const entry of entries) {            // 跳过隐藏目录和非目录            if (!entry.isDirectory() || entry.name.startsWith('.')) {continue;}            const fullPath = path.join(dirPath, entry.name);            const skillMdPath = path.join(fullPath, 'SKILL.md');            // 官方标准：只识别包含 SKILL.md 的目录            if (!fs.existsSync(skillMdPath)) {continue;}            const description = await extractDescriptionFromDir(fullPath);            // 读取元数据            let source: 'local' | 'github' = 'local';            let sourceUrl: string | undefined;            const metaPath = path.join(fullPath, '.skill-meta.json');            if (fs.existsSync(metaPath)) {                try {                    const meta = JSON.parse(await fs.promises.readFile(metaPath, 'utf-8'));                    source = meta.source || 'local';                    sourceUrl = meta.sourceUrl;                } catch { }            }            skills.push({                name: entry.name,                path: fullPath,                description,                isEnabled,                source,                sourceUrl            });        }    } catch (error) {        console.error(`扫描目录 ${dirPath} 失败:`, error);    }    return skills;}/** * 扫描所有 Skills (已激活 + 禁用) */export async function scanAllSkills(): Promise<SkillInfo[]> {    await ensureDirectoriesExist();    const enabledSkills = await scanDirectory(getSkillsPath(), true);    const disabledSkills = await scanDirectory(getDisabledPath(), false);    return [...enabledSkills, ...disabledSkills];}